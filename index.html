<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <title>Tabata timer</title>
    <link rel="manifest" href="tabata.webmanifest">
    <style>
      html {
        height: 100%;
      }
      body {
        align-items: center;
        background-color: #222;
        display: flex;
        flex-direction: column;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        height: 100%;
        justify-content: center;
        text-transform: uppercase;
      }
      body.is-going {
        background-color: #07e896;
      }
      body.is-stopped {
        background-color: #ff2265;
      }
      h1 {
        color: white;
        font-size: 10em;
        font-size: calc(1em + 18vw);
        font-weight: bold;
        line-height: 1;
        margin: 0.25em 0;
      }
      h1.is-on {
        color: #222;
        font-size: calc(1em + 30vw);
      }
      button {
        background-color: #07e896;
        border: none;
        color: #222;
        font-family: inherit;
        font-weight: bold;
        font-size: 5em;
        font-size: calc(1em + 5vw);
        padding: 0.25em 1em;
        text-transform: inherit;
      }
      button:hover,
      button:focus {
        background-image: repeating-linear-gradient(-0.1turn, rgba(0,0,0,.1) 0, rgba(0,0,0,.1) 5px, transparent 5px, transparent 10px);
        outline: none;
      }
    </style>
    <link rel="apple-touch-icon" sizes="180x180" href="/tabata-timer/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/tabata-timer/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/tabata-timer/favicon-16x16.png">
    <link rel="manifest" href="/tabata-timer/manifest.json">
    <link rel="mask-icon" href="/tabata-timer/safari-pinned-tab.svg" color="#07e896">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#07e896">
  </head>

  <body>
    <div id="settings">
      <input type="radio" name="total-time" value="10" id="time-10"><label for="time-10">10 minutes</label>
      <input type="radio" name="total-time" value="20" id="time-20"><label for="time-20">20 minutes</label>
      <input type="radio" name="total-time" value="30" id="time-30"><label for="time-30">30 minutes</label>
    </div>
    <h1></h1>
    <button>Go</button>

    <script>
      // Setup
      const body = document.body;
      const title = document.querySelector('h1');
      const button = document.querySelector('button');
      let countdownInterval = null;
      let startInterval = null;
      let endInterval = null;
      title.textContent = 'Ready?';

      // Settings
      let settings = {};
      const radios = document.getElementById('settings');
function updateSettings(e) {
  if(e.target.nodeName.toLowerCase() === 'input') {
    settings.totalTime = e.target.value;
  }
}
      radios.addEventListener('click', updateSettings);


      // Web Audio API
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      var context = new AudioContext();
      var airhorn, bell;
      function loadSound(url) {
        var getSound = new XMLHttpRequest();
        getSound.open('GET', url, true);
        getSound.responseType = 'arraybuffer';
        getSound.onload = function() {
          context.decodeAudioData(getSound.response, function(buffer){
            if(url.includes('airhorn')) {
              airhorn = buffer;
            } else {
              bell = buffer;
            }
          });
        }
        getSound.send();
      }
      loadSound('airhorn.wav');
      loadSound('bell.wav');

      // Airhorn to start
      function playStartSound() {
        /*const airhorn = new Audio('airhorn.wav');
        airhorn.currentTime = 0;
        airhorn.play();*/
        var playSound = context.createBufferSource();
        playSound.buffer = airhorn;
        // Link the sound to the output
        playSound.connect(context.destination); 
        // Play the sound immediately
        playSound.start(0);
        title.textContent = 'Go';
        title.classList.add('is-on');
        body.classList.add('is-going');
        body.classList.remove('is-stopped');
      }

      // Bell to finish
      function playEndSound() {
        /*const bell = new Audio('bell.wav');
        bell.currentTime = 0;
        bell.play();*/
        var playSound = context.createBufferSource();
        playSound.buffer = bell;
        // Link the sound to the output
        playSound.connect(context.destination); 
        // Play the sound immediately
        playSound.start(0);
        title.textContent = 'Stop';
        body.classList.remove('is-going');
        body.classList.add('is-stopped');
      }

      // 10 second countdown before starting
      function countdown(totalTime=20, callback) {
        button.remove();
        let i = 10;
        title.textContent = i;
        countdownInterval = setInterval(() => {
          i--;
          title.textContent = i;
          if(i === 0) {
            clearInterval(countdownInterval);
            title.textContent = 'Go';
          }
        }, 1000);
        setTimeout(reset, totalTime*60*1000);
        callback();
      }

      // Keep 'er lit'
      function cycle() {
        // Wait 10 seconds then play the start sound
        setTimeout(() => {
          playStartSound();
          startInterval = setInterval(playStartSound, 30000);
        }, 10000);
        // Play end sound every 30 seconds
        endInterval = setInterval(playEndSound, 30000);
      }

      // Put everything back to normal
      function reset() {
        body.classList.remove('is-going', 'is-stopped');
        title.classList.remove('is-on');
        title.textContent = 'Ready?';
        clearInterval(startInterval);
        clearInterval(endInterval);
        document.body.appendChild(button);
      }

      // Listeners
      button.addEventListener('click', () => {
        context.resume();
        const totalTime = settings.totalTime || undefined;
        countdown(totalTime, cycle);
      });

      // iOS fix
      window.addEventListener('touchstart', function() {
        // Create empty buffer
        var buffer = myContext.createBuffer(1, 1, 22050);
        var source = myContext.createBufferSource();
        source.buffer = buffer;
        // Connect to output (your speakers)
        source.connect(myContext.destination);
        // Play the file
        source.noteOn(0);
      });

      // Register service worker
      if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('https://tabatatimer.github.io/tabata-timer/sw.js', {
        scope: '/tabata-timer/'
        }).catch(function(err) {
        console.log('Error: ' + err);
        });
      }
    </script>
  </body>
</html>
